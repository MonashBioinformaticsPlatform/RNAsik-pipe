#----------------------------------------
# Counts
#----------------------------------------

include "sikHeader.bds"
include "sikSanityCheck.bds"

#------------------------------
# Make directories as required
#------------------------------
string countFiles = "countFiles"
if((!countFiles.exists()) && (count)) countFiles.mkdir()
#------
# Body
#------
string[] getReadsCount(string[] bamsList, string gtfFile, string additionalArgs) {

    int featureThreads = threads/2

    string bamString = bamsList.join(" ")

    string featureReverse = countFiles+"/"+"featureReverse.txt"
    task(featureReverse <- bamFiles, taskName := "Counting features") {
        sys featureCounts -a $gtfFile \
                          -o $featureReverse \
                          -s 2 \
                          -T $featureThreads \
                          $additionalArgs \
                          $bamString
    }
    string featureNo = countFiles+"/"+"featureNo.txt"
    task(featureNo <- bamFiles, taskName := "Counting features") {
        sys featureCounts -a $gtfFile \
                          -o $featureNo \
                          -s 0 \
                          -T $featureThreads \
                          $additionalArgs \
                          $bamString
    }
    return [featureNo, featureReverse] 
}

string getGeneIds(){
    string getProgPath = programPath.pathName()

    string makeDB = getProgPath+"/../scripts/make-gtf-db.py" 
    string dbName = gtfFile.baseName().removeExt()+'.db'
    task(dbName <- gtfFile, taskName := "Making db file"){
        sys python $makeDB $gtfFile $dbName
    }

    string getGeneIds = getProgPath+"/../scripts/getGeneIds.py"
    string geneIds = "geneIds.txt"
    task(geneIds <- dbName, taskName := "getting geneIds.txt file") {
        sys python $getGeneIds --dbFile $dbName > $geneIds
    }

    return geneIds
}
